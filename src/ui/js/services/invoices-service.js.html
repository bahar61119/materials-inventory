<script>
    class InvoicesService {
        static #invoiceList = [];
        static #filteredInvoiceList = [];

        static setInvoiceListData() {
            API.getInvoiceList(
                dataReturned => {
                    InvoicesService.#invoiceList = dataReturned.slice();
                    InvoicesService.#filteredInvoiceList = [...InvoicesService.#invoiceList];
                    InvoicesService.search();
                    if(InvoicesService.#invoiceList.length === 0) {
                        Alert.show(
                            AlertOptions.of()
                                .withTitle("Not Found")
                                .withMessage("Please add a new invoice")
                                .withType(AlertOptions.Type.WARNING)
                        );

                        ConfirmationModal.show(
                            ConfirmationModalOptions.of()
                                .withTitle("Not Found")
                                .withMessage(`Do you want to add new invoice?`)
                                .withCallback(()=>{
                                    Alert.hide();
                                    InvoicesViewService.loadAddInvoiceView();
                                })
                                .withType(ConfirmationModalOptions.Type.WARNING)
                        );
                    }
                },
                error => {
                    console.error(error);
                    Alert.show(
                        AlertOptions.of()
                            .withTitle("Loading Error")
                            .withMessage(error.message)
                            .withType(AlertOptions.Type.DANGER)
                    );
                }
            );
        }

        static search() {
            BaseService.search(InvoicesService.#filteredInvoiceList, "invoiceId", "invoiceName", "Invoices");
        }

        static deleteInvoice(invoiceId) {
            BaseService.delete(invoiceId, "Invoice", API.deleteInvoice, InvoicesService.setInvoiceListData);
        }

        static updateInvoice(isEdit = true) {
            let invoice = InvoicesService.#getInvoice(isEdit);
            BaseService.update(invoice, "Invoice", API.updateInvoice, isEdit);
        }

        static filterInvoices(filter) {
            InvoicesService.#filteredInvoiceList = InvoicesService.#getFilteredData(filter);
            InvoicesService.search();
        }

        static #getFilteredData(filter) {
            let filteredData = [...InvoicesService.#invoiceList];
            if(filter.supplier !== 'all') {
                filteredData = filteredData.filter(invoice => invoice.invoiceSupplier === filter.supplier);
            }
            if(filter.fromDate) {
                if(filter.dateType === 'all') {
                    filteredData = filteredData.filter(invoice => {
                        console.log("invoiceIssueDate:" + invoice.invoiceIssueDate);
                        console.log("fromDate:" + filter.fromDate);
                        console.log("greaterThanEqual:"+ (invoice.invoiceIssueDate >= filter.fromDate));
                        return invoice.invoiceIssueDate >= filter.fromDate;
                    });
                    filteredData = filteredData.filter(invoice => invoice.invoiceReceivedDate >= filter.fromDate);
                } else if(filter.dateType === "invoiceIssueDate") {
                    filteredData = filteredData.filter(invoice => invoice.invoiceIssueDate >= filter.fromDate);
                } else {
                    filteredData = filteredData.filter(invoice => invoice.invoiceReceivedDate >= filter.fromDate);
                }
            }
            if(filter.toDate) {
                if(filter.dateType === 'all') {
                    filteredData = filteredData.filter(invoice => invoice.invoiceIssueDate <= filter.toDate);
                    filteredData = filteredData.filter(invoice => invoice.invoiceReceivedDate <= filter.toDate);
                } else if(filter.dateType === "invoiceIssueDate") {
                    filteredData = filteredData.filter(invoice => invoice.invoiceIssueDate <= filter.toDate);
                } else {
                    filteredData = filteredData.filter(invoice => invoice.invoiceReceivedDate <= filter.toDate);
                }
            }
            return filteredData;
        }

        static clearFilterInvoices() {
            $(`#${ElementId.Invoices.LIST_SEARCH}`).val("");
            InvoicesService.#filteredInvoiceList = [...InvoicesService.#invoiceList];
            InvoicesService.search();
        }

        static #getInvoice(isEdit = true) {
            return Invoice.of()
                .withInvoiceId(isEdit? $(`#${ElementId.Invoices.INVOICE_ID}`).val(): '')
                .withInvoiceName($(`#${ElementId.Invoices.INVOICE_NAME}`).val())
                .withInvoiceReferenceNumber($(`#${ElementId.Invoices.INVOICE_REFERENCE_NUMBER}`).val())
                .withInvoiceSupplier($(`#${ElementId.Invoices.INVOICE_SUPPLIER}`).val())
                .withInvoiceCurrency($(`#${ElementId.Invoices.INVOICE_CURRENCY}`).val())
                .withInvoiceAmount($(`#${ElementId.Invoices.INVOICE_AMOUNT}`).val())
                .withInvoiceIssueDate($(`#${ElementId.Invoices.INVOICE_ISSUE_DATE}`).val())
                .withInvoiceReceivedDate($(`#${ElementId.Invoices.INVOICE_RECEIVED_DATE}`).val())
                .withInvoiceDescription($(`#${ElementId.Invoices.INVOICE_DESCRIPTION}`).val())
                .withInvoiceFile($(`#${ElementId.Invoices.INVOICE_FILE}`).val())
        }

        static fileUploadSuccess(fileId) {
            BaseService.fileUploadSuccess(fileId, "Invoices");
        }
    }
</script>