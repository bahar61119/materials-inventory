<script>
    class SupplierService {
        static #supplierList = [];

        static setDataForSupplierSearch() {
            API.getSupplierList(
                dataReturned => {
                    SupplierService.#supplierList = dataReturned.slice();
                    SupplierService.searchSupplier();
                    if(SupplierService.#supplierList.length === 0) {
                        Alert.show(
                            AlertOptions.of()
                                .withTitle("No Suppliers Found")
                                .withMessage("Please add a new Supplier")
                                .withType(AlertOptions.Type.WARNING)
                        );

                        ConfirmationModal.show(
                            ConfirmationModalOptions.of()
                                .withTitle("No Suppliers Found")
                                .withMessage(`Do you want to add new supplier?`)
                                .withCallback(()=>{
                                    Alert.hide();
                                    ViewService.loadAddSupplierView();
                                })
                                .withType(ConfirmationModalOptions.Type.WARNING)
                        );
                    }
                },
                error => {
                    console.error(error);
                    Alert.show(
                        AlertOptions.of()
                            .withTitle("Loading Supplier Error")
                            .withMessage(error.message)
                            .withType(AlertOptions.Type.DANGER)
                    );
                }
            );
        }

        static searchSupplier() {
            let searchInput = document.getElementById(ElementId.Supplier.SUPPLIER_LIST_SEARCH).value;
            let results = DataManipulation.filterData(searchInput, SupplierService.#supplierList);
            let supplierListTable = document.getElementById(ElementId.Supplier.SUPPLIER_LIST_TABLE);
            let template = SupplierService.getTemplate(ElementId.Supplier.SUPPLIER_LIST_ROW_TEMPLATE);

            supplierListTable.innerHTML = "";
            results.forEach(result => {
                let tr = template.cloneNode(true);
                Object.keys(result).forEach(column => {
                    tr.querySelector(`.${column}`).textContent = result[column].toString();
                });

                let supplier = JSON.stringify({
                    supplierId: result.supplierId,
                    supplierName: result.supplierName
                });

                let deleteButton = tr.querySelector(`.${ElementClass.Supplier.DELETE_BUTTON}`);
                deleteButton.dataset.supplier = supplier;

                let editButton = tr.querySelector(`.${ElementClass.Supplier.EDIT_BUTTON}`);
                editButton.dataset.supplier = supplier;
                
                supplierListTable.appendChild(tr);
            });
        }

        static deleteSupplier(supplierId) {
            API.deleteSupplier(
                supplierId,
                dataReturned => {
                    SupplierService.setDataForSupplierSearch();
                    Alert.show(
                        AlertOptions.of()
                            .withTitle("Supplier Delete")
                            .withMessage(`Supplier (ID: ${supplierId}) Deleted successfully`)
                            .withType(AlertOptions.Type.SUCCESS)
                    );
                },
                error => {
                    console.error(error);
                    Alert.show(
                        AlertOptions.of()
                            .withTitle("Supplier Delete Error")
                            .withMessage(error.message)
                            .withType(AlertOptions.Type.DANGER)
                    );
                }
            );
        }

        static editSupplier(supplierId) {
            ViewService.loadEditSupplierView(supplierId);
        }

        static updateSupplier(isEdit = true) {
            let supplier = SupplierService.#getSupplier(isEdit);
            API.updateSupplier(
                supplier,
                dataReturned => {
                    Alert.show(
                        AlertOptions.of()
                            .withTitle("Supplier Update")
                            .withMessage("Supplier Updated successfully")
                            .withType(AlertOptions.Type.SUCCESS)
                    );
                },
                error => {
                    console.error(error);
                    Alert.show(
                        AlertOptions.of()
                            .withTitle("Supplier Update Error")
                            .withMessage(error.message)
                            .withType(AlertOptions.Type.DANGER)
                    );
                }
            );
            
        }

        static getTemplate(templateId) {
            let template = document.getElementById(ElementId.Supplier.SUPPLIER_LIST_ROW_TEMPLATE).content;
            return template.cloneNode(true);
        }

        static #getSupplier(isEdit = true) {
            return Supplier.of()
                .withSupplierId(isEdit? $(`#${ElementId.Supplier.SUPPLIER_ID}`).val(): '')
                .withSupplierName($(`#${ElementId.Supplier.SUPPLIER_NAME}`).val())
                .withSupplierType($(`#${ElementId.Supplier.SUPPLIER_TYPE}`).val())
                .withSupplierCompany($(`#${ElementId.Supplier.SUPPLIER_COMPANY}`).val())
                .withSupplierDesignation($(`#${ElementId.Supplier.SUPPLIER_DESIGNATION}`).val())
                .withSupplierContactNumber($(`#${ElementId.Supplier.SUPPLIER_CONTACT_NUMBER}`).val())
                .withSupplierEmail($(`#${ElementId.Supplier.SUPPLIER_EMAIL}`).val())
                .withSupplierAddress($(`#${ElementId.Supplier.SUPPLIER_ADDRESS}`).val())
        }
    }
</script>